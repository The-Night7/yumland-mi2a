<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Le Grand Miam</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>

<header>
    <nav style="display: flex; justify-content: space-between; align-items: center;">
        <div class="logo-container">
            <a href="../../index.html" class="logo-text">
                Le <span class="logo-highlight">Grand</span> Miam
            </a>
        </div>
        
        <div class="search-bar-nav" style="flex-grow: 1; margin: 0 30px; max-width: 400px;">
            <input type="text" placeholder="Rechercher un plat..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
        </div>

        <ul class="nav-links" style="list-style: none; display: flex; gap: 20px; margin:0; align-items: center;">
            <li><button id="toggle-dark-mode" style="cursor:pointer; background:none; border:none; font-size:1.5rem;" title="Changer de mode">üåô</button></li>
            <li><a href="../../index.html">Accueil</a></li>
            <li><a href="carte.html">La Carte</a></li>
            <li><a href="profil.html" class="active">Mon Compte</a></li>
            <li><a href="#" id="btn-logout" style="color: var(--color-primary); font-weight: bold;">D√©connexion</a></li>
        </ul>
    </nav>
</header>

<main>
    <section class="profile-container">
        <div class="profile-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 id="welcome-title">Mon Profil</h1>
            <a id="link-maps" href="#" target="_blank" class="btn-maps" style="background-color: #4285F4; color: white; padding: 10px 15px; border-radius: 5px; text-decoration: none; font-weight: bold; font-size: 0.9rem;">
                üìç VOIR MON ADRESSE SUR MAPS
            </a>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab(event, 'infos')">Mes Infos</button>
            <button class="tab-btn" onclick="openTab(event, 'fidelite')">Fid√©lit√©</button>
            <button class="tab-btn" onclick="openTab(event, 'historique')">Commandes</button>
        </div>

        <div id="infos" class="tab-content active">
            <div class="ribbon-title">Informations Personnelles</div>
            <form id="profile-form">
                <fieldset style="border:none; padding:0;">
                    <div class="form-group">
                        <label>Nom :</label>
                        <input type="text" id="nom" required>
                    </div>
                    <div class="form-group">
                        <label>Pr√©nom :</label>
                        <input type="text" id="prenom" required>
                    </div>
                    <div class="form-group">
                        <label>Email :</label>
                        <input type="email" id="email" disabled style="opacity: 0.7; background-color: #eee;">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone :</label>
                        <input type="tel" id="tel" placeholder="06 XX XX XX XX">
                    </div>
                    <div class="form-group">
                        <label>Adresse de livraison :</label>
                        <input type="text" id="adresse" placeholder="12 rue de Paris, 95000 Cergy">
                    </div>
                    <div class="form-group">
                        <label>Infos Compl√©mentaires :</label>
                        <input type="text" id="complement" placeholder="Code, √©tage...">
                    </div>
                    <div style="margin-top: 25px;">
                        <button type="submit" class="btn-save" style="width: 100%; padding: 15px; font-weight: bold; cursor: pointer;">METTRE √Ä JOUR MES INFORMATIONS</button>
                    </div>
                </fieldset>
            </form>
        </div>

        <div id="fidelite" class="tab-content">
            <div class="ribbon-title">Le Grand Miam Club</div>
            <div class="loyalty-card" style="text-align: center; padding: 40px; border-radius: 15px;">
                <h3 style="margin:0; text-transform:uppercase;">Mon Solde Actuel</h3>
                <div class="loyalty-points" id="points-display" style="font-size: 4.5rem; font-weight: bold; color: var(--color-primary); margin: 10px 0;">0</div>
                <p style="font-size: 1.5rem;">MIAMS</p>
                <hr style="border: 0; border-top: 1px solid rgba(0,0,0,0.1); margin: 20px 0;">
                <div style="font-size: 1.3rem;">
                    Statut : <strong id="status-display" style="text-transform: uppercase;">Petit Grilleur</strong>
                </div>
            </div>
        </div>

        <div id="historique" class="tab-content">
            <div class="ribbon-title">Derni√®res Commandes</div>
            <table class="history-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #ddd;">
                        <th style="padding: 10px; text-align: left;">Commande</th>
                        <th style="padding: 10px; text-align: left;">Date</th>
                        <th style="padding: 10px; text-align: left;">Note</th>
                        <th style="padding: 10px; text-align: left;">Statut</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 10px;"><strong>#CMD-8854</strong></td>
                        <td style="padding: 10px;">02/02/2026</td>
                        <td style="padding: 10px; color: #FFC107; font-size: 1.2rem;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td>
                        <td style="padding: 10px;"><span class="status-badge status-pending">En cuisine</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
</main>

<footer>
    <p>&copy; 2026 Le Grand Miam - Steakhouse Premium.</p>
</footer>

<script src="../js/auth-client.js"></script>
<script>
    // GESTION DES ONGLETS
    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        const tablinks = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    document.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user) {
            window.location.href = "connexion.html";
            return;
        }

        // REMPLISSAGE INFOS
        document.getElementById('welcome-title').textContent = `Profil de ${user.prenom}`;
        document.getElementById('nom').value = user.nom || '';
        document.getElementById('prenom').value = user.prenom || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('tel').value = user.tel || '';
        document.getElementById('adresse').value = user.adresse || '';
        document.getElementById('complement').value = user.complement || '';

        if(user.adresse) {
            document.getElementById('link-maps').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(user.adresse)}`;
        }

        // FIDELITE
        const miams = user.miams || 0;
        document.getElementById('points-display').textContent = miams;
        if (typeof getStatutFidelite === "function") {
            const statut = getStatutFidelite(miams);
            const statusDisplay = document.getElementById('status-display');
            statusDisplay.textContent = statut.nom;
            statusDisplay.style.color = statut.couleur;
        }

        // MODE NUIT HAUTE VISIBILIT√â
        const toggleBtn = document.getElementById('toggle-dark-mode');
        toggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            toggleBtn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        });

        // MISE √Ä JOUR
        document.getElementById('profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            user.nom = document.getElementById('nom').value;
            user.prenom = document.getElementById('prenom').value;
            user.tel = document.getElementById('tel').value;
            user.adresse = document.getElementById('adresse').value;
            user.complement = document.getElementById('complement').value;

            sessionStorage.setItem('currentUser', JSON.stringify(user));

            const allUsers = JSON.parse(localStorage.getItem('yumland_users')) || [];
            const idx = allUsers.findIndex(u => u.email === user.email);
            if(idx !== -1) {
                allUsers[idx] = {...allUsers[idx], ...user};
                localStorage.setItem('yumland_users', JSON.stringify(allUsers));
                alert("Donn√©es enregistr√©es !");
                location.reload();
            }
        });

        // DECONNEXION
        document.getElementById('btn-logout').addEventListener('click', (e) => {
            e.preventDefault();
            sessionStorage.removeItem('currentUser');
            window.location.href = "connexion.html";
        });
    });
</script>
</body>
</html>