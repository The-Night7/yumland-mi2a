<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Le Grand Miam</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Oswald:wght@700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../css/style.css">
</head>
<body>

<header>
    <nav style="display: flex; justify-content: space-between; align-items: center;">
        <div class="logo-container">
            <a href="../../index.html" class="logo-text">
                Le <span class="logo-highlight">Grand</span> Miam
            </a>
        </div>
        <ul class="nav-links" style="list-style: none; display: flex; gap: 20px; margin:0;">
            <li><a href="../../index.html">Accueil</a></li>
            <li><a href="carte.html">La Carte</a></li>
            <li><a href="profil.html" class="active">Mon Compte</a></li>
            <li><a href="#" id="btn-logout" style="color: var(--color-primary); font-weight: bold;">D√©connexion</a></li>
        </ul>
    </nav>
</header>

<main>
    <section class="profile-container">
        <div class="profile-header">
            <h1 id="welcome-title">Mon Profil</h1>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab(event, 'infos')">Mes Infos</button>
            <button class="tab-btn" onclick="openTab(event, 'fidelite')">Fid√©lit√©</button>
            <button class="tab-btn" onclick="openTab(event, 'historique')">Commandes</button>
        </div>

        <div id="infos" class="tab-content active">
            <div class="ribbon-title">Les informations personnelles (RGPD)</div>

            <form id="profile-form">
                <fieldset>
                    <div class="form-group">
                        <label for="nom">Nom :</label>
                        <input type="text" id="nom" name="nom" required>
                    </div>
                    <div class="form-group">
                        <label for="prenom">Pr√©nom :</label>
                        <input type="text" id="prenom" name="prenom" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email :</label>
                        <input type="email" id="email" name="email" required disabled style="background-color: #f0f0f0; cursor: not-allowed;" title="L'email sert d'identifiant et ne peut √™tre modifi√©">
                    </div>
                    <div class="form-group">
                        <label for="tel">T√©l√©phone¬†:</label>
                        <input type="tel" id="tel" name="tel" placeholder="Ex: 06¬†12¬†34¬†56¬†78">
                        <span class="edit-icon" style="margin-left:8px; cursor:pointer;">‚úèÔ∏è</span>
                    </div>

                    <!-- Champ Adresse ajout√© pour la phase¬†1 -->
                    <div class="form-group">
                        <label for="adresse">Adresse¬†:</label>
                        <input type="text" id="adresse" name="adresse" placeholder="12 rue de Paris, 95000 Cergy">
                        <span class="edit-icon" style="margin-left:8px; cursor:pointer;">‚úèÔ∏è</span>
                    </div>

                    <!-- Champ Informations compl√©mentaires (code interphone, √©tage, etc.) -->
                    <div class="form-group">
                        <label for="complement">Infos Compl√©mentaires¬†:</label>
                        <input type="text" id="complement" name="complement" placeholder="Code interphone, √©tage, etc.">
                        <span class="edit-icon" style="margin-left:8px; cursor:pointer;">‚úèÔ∏è</span>
                    </div>

                    <div style="clear:both; margin-top: 20px;">
                        <button type="submit" class="btn-save">METTRE √Ä JOUR</button>
                    </div>
                </fieldset>
            </form>
        </div>

        <div id="fidelite" class="tab-content">
            <div class="ribbon-title">Les informations de fid√©lit√© (pts)</div>
            <div class="loyalty-card">
                <h3 style="margin:0; text-transform:uppercase; letter-spacing:1px; color:rgba(255,255,255,0.9);">Solde Actuel</h3>
                <div class="loyalty-points" id="points-display">0</div>
                <p style="font-size:1.2rem;">MIAMS</p>
                <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>Statut : <strong style="color: var(--color-primary);" id="status-display"></strong></span>
                </div>
            </div>
        </div>

        <div id="historique" class="tab-content">
            <div class="ribbon-title">Les derni√®res commandes (historique)</div>
            <p><em>Historique simul√© pour la d√©monstration graphique.</em></p>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                    <tr>
                        <th>Commande</th>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Statut</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><strong>#CMD-8854</strong></td>
                        <td>02/02/2026</td>
                        <td>45.50 ‚Ç¨</td>
                        <td><span class="status-badge status-pending">En cuisine</span></td>
                        <td><a href="#" style="color:var(--color-primary); font-weight:bold; text-decoration:none;">Voir</a></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </section>
</main>

<footer>
    <p>&copy; 2026 Le Grand Miam - Steakhouse Premium.</p>
    <p>
        <a href="mentions.html">Mentions L√©gales</a>
    </p>
</footer>

<script src="../js/auth-client.js"></script>
<script>
    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        const tablinks = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    document.addEventListener('DOMContentLoaded', () => {
        const currentUserJSON = sessionStorage.getItem('currentUser');
        if (!currentUserJSON) {
            window.location.href = "connexion.html";
            return;
        }

        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
            btnLogout.addEventListener('click', (e) => {
                e.preventDefault(); // Emp√™che le lien de recharger la page
                
                // 1. On vide les donn√©es de session (s√©curit√©)
                sessionStorage.removeItem('currentUser');
                localStorage.removeItem('currentUser'); // Pour √™tre s√ªr selon ta m√©thode de stockage
                
                // 2. Message de confirmation
                alert("Vous avez √©t√© d√©connect√© avec succ√®s. √Ä bient√¥t chez Le Grand Miam !");
                
                // 3. Redirection vers la page de connexion
                window.location.href = "connexion.html";
            });
        }
        const user = JSON.parse(currentUserJSON);

        // --- REMPLACEMENT DU STATUT BRONZE ---
        const miams = user.miams || user.points || 0;
        const pointsDisplay = document.getElementById('points-display');
        const statusDisplay = document.getElementById('status-display');

        if(pointsDisplay) pointsDisplay.textContent = miams;

        if (typeof getStatutFidelite === "function") {
            const statut = getStatutFidelite(miams);
            if(statusDisplay) {
                statusDisplay.textContent = statut.nom; // Remplace "BRONZE" par le vrai nom
                statusDisplay.style.color = statut.couleur; // Applique la couleur Or, Rouge ou Gris
            }
        }

        // --- INJECTION DES INFOS ---
        document.getElementById('welcome-title').textContent = `Profil de ${user.prenom}`;
        document.getElementById('nom').value = user.nom || '';
        document.getElementById('prenom').value = user.prenom || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('tel').value = user.tel || '';
        document.getElementById('adresse').value = user.adresse || '';
        document.getElementById('complement').value = user.complement || '';

        // --- MODE NUIT HAUTE VISIBILIT√â ---
        const nightBtn = document.createElement('button');
        nightBtn.innerHTML = "üåô";
        nightBtn.style = "position:fixed; bottom:20px; right:20px; z-index:1000; padding:15px; border-radius:50%; border:none; cursor:pointer; font-size:1.5rem; background:var(--color-secondary); color:var(--color-accent);";
        document.body.appendChild(nightBtn);

        nightBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            nightBtn.innerHTML = document.body.classList.contains('dark-mode') ? "‚òÄÔ∏è" : "üåô";
        });

        // --- MISE √Ä JOUR ---
        document.getElementById('profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            user.nom = document.getElementById('nom').value;
            user.prenom = document.getElementById('prenom').value;
            user.tel = document.getElementById('tel').value;
            user.adresse = document.getElementById('adresse').value;
            user.complement = document.getElementById('complement').value;

            sessionStorage.setItem('currentUser', JSON.stringify(user));
            alert("Modifications enregistr√©es !");
        });
    });
</script>
</body>
</html>